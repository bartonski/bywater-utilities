<p><style>
table
{
    border-collapse:collapse;
    width: 1200px;
}
table,th, td
{
    border: 1px solid black;
}
</style></p>


<h1 id="adding-an-index-to-zebra">Adding an Index to Zebra:</h1>
<h2 id="overview">Overview</h2>
<p>In order for a bib record or authority record to be search-able within Koha, we must add an index to Zebra. Zebra uses two protocols for indexing its data: GRS1 and DOM. GRS1 is deprecated in favor of DOM. Unless there are special circumstances, we will always use DOM indexing.</p>
<p>Koha also shares its data via two different protocols: Z39.50 and SRU. Any zebra indexes must also be added to the configuration for these protocols, in order for clients querying Koha's Z39.50 or SRU servers to be able to find bibliographic information.</p>
<p>Once the zebra index has been added, the search options must also display on Koha's search menus in the OPAC and staff client. Indexes are hard-coded in C4/Search.pm, and changes must also be made to the template tool-kit templates for OPAC and staff client.</p>
<p>Finally, a full zebra re-index must be run in order for the new indexes to become available.</p>
<h2 id="notes-on-deployment-and-upgrade.">Notes on deployment and upgrade.</h2>
<p>All changes should be made in a git environment, so that changes in configuration files may be re-applied as patches during upgrade. This means that package sites must use 'gitify', in order to provide a git environment.</p>
<p>Changes are <em>not</em> made directly to the configuration files used by a running koha instance, rather, the changes are made in the git environment then deployed to $HOME/koha-dev/ (in the case of a 'git' install) or to the standard configuration directories used by package sites. This is done via an install process; details will vary between git install and and package site/gitify install.</p>
<h2 id="files-and-variables">Files and variables</h2>
<h3 id="fields">Fields</h3>
<p>There are esseintally three variables tracked by the koha index files:</p>
<ol style="list-style-type: decimal">
<li>Marc field -- As defined by the relevant standards body, e.g. <a href="http://www.loc.gov/marc/">http://www.loc.gov/marc/</a></li>
<li>Zebra index -- This is how Zebra and Koha refer to the zebra index. Index names have the form Zebra index name:Zebra index search type.
<ol style="list-style-type: decimal">
<li>Zebra index name should consiste of upper and lower case characters and dashes, e.g. 'Local-classification'.</li>
<li>Zebra index search type should be 'w' (exact single word search), 'p' (exact phrase), 'n' (numeric) or 's' (string). Use 'w' unless you have a good reason not to.</li>
</ol></li>
<li>Z39.50 Attributes -- A pre-defined set of numeric values given to allow Z39.50 searches. See <a href="http://www.loc.gov/z3950/agency/bib1.html">http://www.loc.gov/z3950/agency/bib1.html</a>.</li>
</ol>
<table>
<col width="52%" />
<col width="32%" />
<col width="15%" />
<tbody>
<tr class="odd">
<td align="left"><p>File Name</p></td>
<td align="left"><p>Purpose</p></td>
<td align="left"><p>Environment</p></td>
</tr>
</tbody>
</table>
<table>
<col width="52%" />
<col width="32%" />
<col width="15%" />
<thead>
<tr class="header">
<th align="left">Marc Record to zebra index name</th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>~/kohaclone/etc/zebradb/marc_defs/marc21/biblios/record.abs</p></td>
<td align="left"><p>Associates marc field to zebra index</p></td>
<td align="left"><p>GRS1 index</p></td>
</tr>
<tr class="even">
<td align="left"><p>~/kohaclone/etc/zebradb/marc_defs/marc21/biblios/biblio-koha-indexdefs.xml</p></td>
<td align="left"><p>Associates marc field to zebra index</p></td>
<td align="left"><p>DOM index, Source file</p></td>
</tr>
<tr class="odd">
<td align="left"><p>~/kohaclone/etc/zebradb/marc_defs/marc21/biblios/biblio-koha-indexdefs.xsl</p></td>
<td align="left"><p>Associates marc field to zebra index</p></td>
<td align="left"><p>DOM index, xslt</p></td>
</tr>
</tbody>
</table>
<table>
<col width="52%" />
<col width="32%" />
<col width="15%" />
<thead>
<tr class="header">
<th align="left">Z39.50 attribute to zebra index name</th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>~/kohaclone/etc/zebradb/biblios/etc/bib1.att</p></td>
<td align="left"><p>Associates Z39.50 attribute to zebra index name</p></td>
<td align="left"><p>Z39.50 search</p></td>
</tr>
<tr class="even">
<td align="left"><p>~/kohaclone/etc/zebradb/ccl.properties</p></td>
<td align="left"><p>Associates Z39.50 attribute to zebra index name</p></td>
<td align="left"><p>Koha search</p></td>
</tr>
<tr class="odd">
<td align="left"><p>~/kohaclone/etc/zebradb/pqf.properties</p></td>
<td align="left"><p>Associates Z39.50 attribute to zebra index name</p></td>
<td align="left"><p>SRU, Query Parser</p></td>
</tr>
</tbody>
</table>
<table>
<col width="52%" />
<col width="32%" />
<col width="15%" />
<thead>
<tr class="header">
<th align="left">Koha source and template files</th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>~/kohaclone/C4/Search.pm</p></td>
<td align="left"><p>Zebra index name must appear in getIndexes()</p></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><p>~/koha-tmpl/opac-tmpl/bootstrap/en/modules/opac-advsearch.tt</p></td>
<td align="left"><p>Display index as search option in OPAC</p></td>
<td align="left"><p>OPAC Advanced Search</p></td>
</tr>
<tr class="odd">
<td align="left"><p>~/koha-tmpl/intranet-tmpl/prog/en/modules/catalogue/advsearch.tt</p></td>
<td align="left"><p>Display index as search option in Staff Client</p></td>
<td align="left"><p>Advanced Search</p></td>
</tr>
</tbody>
</table>
<table>
<col width="52%" />
<col width="32%" />
<col width="15%" />
<thead>
<tr class="header">
<th align="left">Zebra indexing for Autority Records</th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>~/kohaclone/etc/zebradb/marc_defs/marc21/autorities/record.abs</p></td>
<td align="left"><p>Associates marc field to zebra index</p></td>
<td align="left"><p>GRS1 index, authorities</p></td>
</tr>
<tr class="even">
<td align="left"><p>~/kohaclone/etc/zebradb/marc_defs/marc21/autorities/autority-koha-indexdefs.xml</p></td>
<td align="left"><p>Associates marc field to zebra index | DOM</p></td>
<td align="left"><p>index, authorities src</p></td>
</tr>
<tr class="odd">
<td align="left"><p>~/kohaclone/etc/zebradb/marc_defs/marc21/autorities/autority-koha-indexdefs.xsl</p></td>
<td align="left"><p>Associates marc field to zebra index | DOM</p></td>
<td align="left"><p>index, authorities xslt</p></td>
</tr>
<tr class="even">
<td align="left"><p>~/kohaclone/etc/zebradb/autorities/etc/bib1.att</p></td>
<td align="left"><p>Associates Z39.50 attribute to zebra index name</p></td>
<td align="left"><p>Z39.50 search</p></td>
</tr>
</tbody>
</table>
<p>DOM indexing and GRS1 are mutually exclusive. Either record.abs will be used in the case of GRS1, or *-koha-indexdefs.xml will be used; we will not support both.</p>
<p>Zebra's indexing rules use fall-through logic, so the most general rule should be at the end of a chain of possibly matching rules to act as a catch-all. For example, 022$a (ISSN) is indexed before 022:</p>
<pre><code>&lt;index_subfields xmlns=&quot;http://www.koha-community.org/schemas/index-defs&quot; tag=&quot;022&quot; subfields=&quot;a&quot;&gt;
  &lt;target_index&gt;ISSN:w&lt;/target_index&gt;
  &lt;target_index&gt;Identifier-standard:w&lt;/target_index&gt;
&lt;/index_subfields&gt;
&lt;index_data_field xmlns=&quot;http://www.koha-community.org/schemas/index-defs&quot; tag=&quot;022&quot;&gt;
  &lt;target_index&gt;Identifier-standard:w&lt;/target_index&gt;
&lt;/index_data_field&gt;</code></pre>
<h2 id="steps-by-step-instructions-for-adding-a-new-zebra-index">Steps by step instructions for adding a new Zebra index</h2>
<ol style="list-style-type: decimal">
<li><p>Determine whether or not we are using DOM indexing. If koha-conf.xml contains the following lines in the <config> section:</p>
<pre><code>&lt;zebra_bib_index_mode&gt;dom&lt;/zebra_bib_index_mode&gt;
&lt;zebra_auth_index_mode&gt;dom&lt;/zebra_auth_index_mode&gt;</code></pre>
Then zebra will use DOM indexing. Otherwise the site is configured for GRS1. (note that the <config> section also contains mysql user, pass and database information; it should look familiar to you) If configured for GRS1, have larryb convert from GRS1 to DOM indexing.</li>
<li>If adding a zebra index to a package site, the site must be gitified. Have larryb gitify the site. Until 3.14, package sites used GRS1 by default, gitifying and changing to DOM indexing will probably be done in tandem. Note that gitifying a site is done on <em>an instance by instance</em> basis, allowing us to modify zebra index files for one instance but not another.</li>
<li><p>Before editing any files, change directory to ~/kohaclone and run the following commands:</p>
<pre><code>git diff
git status</code></pre>
There should be no output from the 'git diff' command, and 'git status' should not show any modified files.</li>
<li>Run 'git branch'. Note which branch you are on. This will be &lt;ORIGIONAL BRANCH NAME&gt; in the steps below.</li>
<li>Run 'git checkout -b &quot;RT-XXXX&quot;' where XXXX is the RT ticket number of the request to add the zebra index.</li>
<li>Determine whether you can use an already defined zebra index. You may not have to add an index from scratch if Koha has an index that you can add to, or an un-used index. Look in the 'getIndexes' subroutine of ~/kohaclone/C4/Search.pm to see which index names are hard-coded. Refer to ~/kohaclone/etc/zebradb/biblios/etc/bib1.att and ~/kohaclone/etc/zebradb/marc_defs/marc21/biblios/record.abs which may have indexes which were added, but commented out; these are typically good choices.</li>
<li>Run 'touch ~/kohaclone/.koha_zebra_index_modified'<br /> This will allow upgrade scripts to determine whether or not a site has modified index files.</li>
<li><p>Edit the index definitions Open ~/kohaclone/etc/zebradb/marc_defs/marc21/biblios/biblio-koha-indexdefs.xml in a text editor. Marc fields are specified by 'tag', subfields by 'subfield'. Zebra index is specified using the '&lt;target_index&gt;' xml tag. For example 035$a (System Control Number, often used for OCLC numbers), would be specified as follows:</p>
<pre><code>&lt;index_subfields xmlns=&quot;http://www.koha-community.org/schemas/index-defs&quot; tag=&quot;035&quot; subfields=&quot;a&quot;&gt;
  &lt;target_index&gt;Local-number:w&lt;/target_index&gt;
  &lt;target_index&gt;Identifier-standard:w&lt;/target_index&gt;
&lt;/index_subfields&gt;</code></pre>
These lines should be added between the opening and closing &lt;kohaidx&gt; xml tags.</li>
<li>Choose a bib-1 (aka Z39.50) attribute -- find the closest matching attribute.</li>
<li><p>Edit ~/kohaclone/etc/zebradb/biblios/etc/bib1.att. The syntax is</p>
<pre><code>att bib1 attribute    Zebra index name</code></pre>
<p>In our 'OCLC Number' example, we will use 12 (bib-1 attribute 12 is 'Local Number'), the Zebra index name already available is also 'Local-number', so the line in bib1.att looks like this:</p>
<pre><code>att 12    Local-number</code></pre></li>
<li><p>Edit ~/kohaclone/etc/zebradb/ccl.properties The syntax is</p>
<pre><code>Zebra index-name 1=bib1 attribute</code></pre>
<p>The string '1=' starts with the numeral 1. The ccl.properties line corresponding to the bib1.att record above would look like this:</p>
<pre><code>Local-number 1=12</code></pre></li>
<li>If you have added a bib1 attribute and you are using SRU, you will have to edit ~/kohaclone/etc/zebradb/pqf.properties. This is currently beyond the scope of this document.</li>
<li><p>If you have added a new Zebra index, the Zebra index name will need to be added to the getIndexes subroutine in ~/kohaclone/C4/Search.pm. Index names are defined in the @indexes array. The array is divided into three sections: biblio indexes, items indexes and subject related (this section is empty). Index names are alphabetical by section. The sections are simply for organizational purposes, it doesn't matter where you add the index name from a syntactic perspective. Use your judgement and add a comment after any element that you add to this array.</p>
<pre><code>sub getIndexes{
    my @indexes = (
                    # biblio indexes
                    &#39;ab&#39;,
                    &#39;Abstract&#39;,
                    &#39;acqdate&#39;,
                    &#39;allrecords&#39;,
                    &#39;an&#39;,
                    &#39;Any&#39;,
...</code></pre></li>
<li>Make new indexes searchable in opac and staff client advanced search. This can be done by editing the opac and staff client templates, or by editing intranetuserjs and opacuserjs respectively.
<ol>
<li>Editing templates:
<ul>
<li><p>The syntax for a search menu item is:</p>
<pre><code>&lt;option value=&quot;Zebra index name,Search Type&quot;&gt;MENU TEXT&lt;/option&gt;</code></pre>
<p>Search type is related, but not identical to 'Zebra index search type':</p></li>
</ul>
<table>
<col width="36%" />
<col width="19%" />
<tbody>
<tr class="odd">
<td align="left"><p>Zebra index search type</p></td>
<td align="left"><p>Search type</p></td>
</tr>
<tr class="even">
<td align="left"><p>w</p></td>
<td align="left"><p>kw, wrdl</p></td>
</tr>
<tr class="odd">
<td align="left"><p>p</p></td>
<td align="left"><p>phr</p></td>
</tr>
<tr class="even">
<td align="left"><p>n</p></td>
<td align="left"><p>?</p></td>
</tr>
<tr class="odd">
<td align="left"><p>s</p></td>
<td align="left"><p>?</p></td>
</tr>
</tbody>
</table>
<ul>
<li>~/koha-tmpl/opac-tmpl/bootstrap/en/modules/opac-advsearch.tt</li>
<li>~/koha-tmpl/intranet-tmpl/prog/en/modules/catalogue/advsearch.tt</li>
</ul></li>
<li>Editing intranetuserjs, opacuserjs
<ol>
<li><p>Add the following to intranetuserjs, with the proper substitutions:</p>
<pre><code>// Add OCLC Number to advanced search
if (window.location.href.indexOf(&quot;catalogue/search.pl&quot;) &gt; -1) {
    $(&quot;.advsearch&quot;).append(&#39;&lt;option value=&quot;Zebra index name,search type&quot;&gt;MENU TEXT&lt;/option&gt;&#39;);
}             </code></pre></li>
<li><p>Add the following to opacuserjs, with the proper substitutions:</p>
<pre><code>// Add OCLC Number to advanced search
if (window.location.href.indexOf(&quot;koha/opac-search.pl&quot;) &gt; -1) {
    $(&quot;.advsearch&quot;).append(&#39;&lt;option value=&quot;Zebra index name,search type&quot;&gt;MENU TEXT&lt;/option&gt;&#39;);
}</code></pre></li>
</ol></li>
</ol></li>
<li>Commit changes to git
<ol style="list-style-type: decimal">
<li>run 'git status' this should show a list of the files that you have modified.</li>
<li>run 'git add' for each modified file.</li>
<li>run 'git commit -m 'my message''. The message should be in the form '@RT &lt;RT ticket#&gt;: &lt;SITE NAME&gt;: Add zebra index for &lt;PURPOSE OF INDEX&gt; at &lt;MARC FIELD&gt; &lt;SUBFIELD&gt;', e.g. '@RT 17200: aarome: Add zebra index for OCLC number at 035 a'. Note that the '$' marc subfield delimiter has been replaced with a space, in order to avoid accidental issues with shell variable expansion.</li>
<li>run 'git format-patch HEAD~1'</li>
<li>Note the name of the generated patch.</li>
<li>Copy the patch to ~/bwspatches</li>
<li>Run 'git checkout &lt;ORIGINAL BRANCH NAME&gt;'</li>
<li>Add a note to <a href="https://docs.google.com/a/bywatersolutions.com/spreadsheet/ccc?key=0Au16RCbfheUwdGJNd05NOGlHeHVVN1JDMS1rNGpIRGc&amp;usp=drive_web#gid=0">system.upgrade_schedules</a>
<ol style="list-style-type: decimal">
<li>Document the RT ticket number</li>
<li>Document the name of the patch</li>
<li>Document the index being added</li>
<li>Document any special notes for whoever is running upgrades/applying patches.</li>
</ol></li>
</ol></li>
<li>The following steps will need to be taken either on first install or on upgrade:
<ol style="list-style-type: decimal">
<li>Run 'git am -3 [0001-this-is-my-patch].patch'</li>
<li>Install the changes made in ~/kohaclone to the running koha environment.
<ol style="list-style-type: decimal">
<li>The steps will vary between a git install and a gitified package install, but should look similar to <a href="http://wiki.koha-community.org/wiki/MRenvoize/Updating_Koha_Install">these</a>.</li>
<li><p>biblio-zebra-indexdefs.xsl must be re-generated after koha-indexdefs-to-zebra.xsl is edited. In a package install, $PATH_TO_ZEBRA_INDEXDEFS will be '/etc/koha/zebradb/marc_defs/marc21/biblios'. For a git install, use $HOME/koha-dev/etc/zebradb/marc_defs/marc21/biblios instead.</p>
<pre><code>/usr/bin/xsltproc ~/kohaclone/etc/zebradb/xsl/koha-indexdefs-to-zebra.xsl \
~/kohaclone/etc/zebradb/marc_defs/marc21/biblios/biblio-koha-indexdefs.xml  \
&gt;  $PATH_TO_ZEBRA_INDEXDEFS/biblio-zebra-indexdefs.xsl</code></pre></li>
</ol></li>
<li>A full zebra rebuild is necessary after any index is added.</li>
</ol></li>
</ol>
<h2 id="community-resources">Community resources:</h2>
<p><a href="http://wiki.koha-community.org/wiki/MRenvoize/zebra">ashimema's zebra wiki page</a></p>
